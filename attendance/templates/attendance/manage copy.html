{% extends 'attendance/basic.html' %}

{% block title %}Manage users{% endblock %}

{% block body %}
<div class="d-flex">
    <div>
        <h1 class="mt-4">Quản lý sinh viên</h1>
    </div>
    <div class="ms-auto mt-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload</button>
        <button type="button" id="download-excel-btn" class="btn btn-success">Tải dữ liệu Excel</button>
        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#CreateFormModal">
            Thêm sinh viên
        </button>
    </div>
</div>

<hr>

<div class="container-fluid text-center">
    <div class="table-responsive" style="height: 100%;">
        <table class="table">
            <thead class="table-dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Họ tên</th>
                    <th scope="col">Lớp</th>
                    <th scope="col">Mã sinh viên</th>
                    <th scope="col">Số điện thoại</th>
                    <th scope="col">Giới tính</th>
                    <th scope="col">Chỉnh sửa</th>
                </tr>
            </thead>
            <tbody id="manage" class="manage">
                {% for user in users %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ user.name|default:"None" }}</td>
                    <td>{{ user.class_name|default:"None" }}</td>
                    <td>{{ user.masv|default:"None" }}</td>
                    <td>{{ user.phone|default:"None" }}</td>
                    <td>
                        {% if user.sex == "male" %} Nam
                        {% elif user.sex == "female" %} Nữ
                        {% else %} Khác
                        {% endif %}
                    </td>
                    <td>
                        <button class="edit-btn btn btn-primary btn-xs" type="button" data-user-card-id="{{ user.id }}"
                            data-user-name="{{ user.name }}" data-user-class="{{ user.class_name }}"
                            data-user-masv="{{ user.masv }}" data-user-phone="{{ user.phone }}"
                            data-user-sex="{{ user.sex }}" data-user-email="{{ user.email }}">Edit</button>
                        <button class="btn btn-danger btn-xs" type="button" onclick="removeItem('{{ user.id }}')">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Upload File Excel -->
<div class="modal fade custom-modal-xl" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload File Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="fileInput" class="form-label">Chọn tệp:</label>
                    <input class="form-control" type="file" id="fileInput" name="file" required>
                </div>
                <div id="resultTableContainer" class="table-responsive mt-3"></div>
                <button id="updateDataBtn" class="btn btn-success mt-3">Cập nhật dữ liệu</button>
            </div>
        </div>
    </div>
</div>
<!-- Create Modal -->
<div class="modal fade" id="CreateFormModal" tabindex="-1" aria-labelledby="FormModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="FormModalLabel">Thêm sinh viên mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-form" action="{% url 'cardadd' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Họ tên:</label>
                        <input type="text" class="form-control" name="name">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Lớp:</label>
                        <input type="text" class="form-control" name="class_name">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Mã sinh viên:</label>
                        <input type="text" class="form-control" name="masv">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Số điện thoại:</label>
                        <input type="text" class="form-control" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Email:</label>
                        <input type="text" class="form-control" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="gender" class="col-form-label">Giới tính:</label>
                        <select class="form-select" name="sex">
                            <option value="male">Nam</option>
                            <option value="female">Nữ</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
            </div>
            <div class="modal-footer" id="ModalFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-warning">Thêm</button>
            </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="EditFormModal" tabindex="-1" aria-labelledby="FormModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="FormModalLabel">Chỉnh sửa thông tin sinh viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-form" action="{% url 'edit_student' 0 %}" method="post">
                    <!-- Placeholder '0' sẽ được thay thế bằng ID -->
                    {% csrf_token %}
                    <input type="hidden" name="student_id" id="student-id"> <!-- Hidden field for student ID -->
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Họ tên:</label>
                        <input type="text" class="form-control" name="name">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Lớp:</label>
                        <input type="text" class="form-control" name="class_name">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Mã sinh viên:</label>
                        <input type="text" class="form-control" name="masv">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Số điện thoại:</label>
                        <input type="text" class="form-control" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Email:</label>
                        <input type="text" class="form-control" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="gender" class="col-form-label">Giới tính:</label>
                        <select class="form-select" name="sex">
                            <option value="male">Nam</option>
                            <option value="female">Nữ</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-warning">Cập nhật</button>
            </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    $(document).ready(function () {
        // Hàm tiền xử lý khi nhấn nút "Thêm"
        function handleSubmit() {
            var name = $('input[name="name"]').val();
            var className = $('input[name="class_name"]').val();
            var masv = $('input[name="masv"]').val();
            var phone = $('input[name="phone"]').val();
            var email = $('input[name="email"]').val();
            var sex = $('select[name="sex"]').val();

            if (!name || !className || !masv || !phone || !email || !sex) {
                $('#errorModalBody').text('Vui lòng điền đầy đủ thông tin.');
                $('#errorModal').modal('show');
                return false;
            }

            return true;
        }

        $('#create-button').click(function () {
            return handleSubmit();
        });

        $('.edit-btn').click(function () {
            var studentId = $(this).data('user-card-id');  // Lấy ID của sinh viên
            var name = $(this).data('user-name');  // Lấy tên sinh viên
            var className = $(this).data('user-class');  // Lấy lớp của sinh viên
            var masv = $(this).data('user-masv');  // Lấy mã sinh viên
            var phone = $(this).data('user-phone');  // Lấy số điện thoại
            var sex = $(this).data('user-sex');  // Lấy giới tính
            var email = $(this).data('user-email');  // Lấy email

            // Cập nhật URL action của form với ID đúng
            var formActionUrl = "{% url 'edit_student' 0 %}".replace('0', studentId);
            $('#edit-form').attr('action', formActionUrl);

            // Điền thông tin vào các trường của form
            $('#edit-form').find('input[name="student_id"]').val(studentId);
            $('#edit-form').find('input[name="name"]').val(name);
            $('#edit-form').find('input[name="class_name"]').val(className);  // Điền class_name
            $('#edit-form').find('input[name="masv"]').val(masv);
            $('#edit-form').find('input[name="phone"]').val(phone);
            $('#edit-form').find('select[name="sex"]').val(sex);
            $('#edit-form').find('input[name="email"]').val(email);

            // Mở modal chỉnh sửa
            $('#EditFormModal').modal('show');
        });


        $('#download-excel-btn').click(function () {
            $.ajax({
                url: "{% url 'download_excel' %}",
                type: 'GET',
                success: function (data) {
                    window.location = "{% url 'download_excel' %}";
                },
                error: function (xhr, status, error) {
                    alert('Đã xảy ra lỗi khi tải xuống dữ liệu Excel.');
                }
            });
        });
    });
    function removeItem(id) {
        if (confirm(`Bạn có chắc chắn muốn xóa sinh viên với ID ${id}?`)) {
            fetch(`/card-delete/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // Django CSRF token
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (response.ok) {
                        location.reload(); // Reload lại trang sau khi xóa thành công
                    } else {
                        throw new Error('Có lỗi xảy ra khi xóa sinh viên.');
                    }
                })
                .catch(error => {
                    console.error(error.message);
                    alert('Đã xảy ra lỗi: ' + error.message);
                });
        } else {
            console.log("Hủy bỏ xóa.");
        }
    }

    document.getElementById('download-excel-btn').addEventListener('click', function () {
        window.location.href = "{% url 'download_excel' %}";
    });
</script>
<script>
    // Xử lý sự kiện chọn file để tự động upload và xem trước dữ liệu
    $('#fileInput').change(function (e) {
        const file = e.target.files[0];  // Lấy file đã chọn
        if (file) {
            let formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: "{% url 'upload_excel' %}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        renderPreviewTable(response.data);
                    } else {
                        alert('Lỗi: ' + response.error_message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi upload:', error);
                    alert('Lỗi khi upload. Vui lòng thử lại.');
                }
            });
        }
    });

    function renderPreviewTable(data) {
        let tableHTML = `<table class="table table-bordered">
            <thead><tr><th>Họ tên</th><th>Lớp</th><th>Mã SV</th><th>SĐT</th><th>Giới tính</th><th>Email</th></tr></thead><tbody>`;

        data.forEach(row => {
            tableHTML += `<tr>
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
                <td>${row[4]}</td>
                <td>${row[5]}</td>
            </tr>`;
        });

        tableHTML += `</tbody></table>`;
        $('#resultTableContainer').html(tableHTML);
    }

    $('#updateDataBtn').click(function () {
        const data = [];
        $('#resultTableContainer tbody tr').each(function () {
            const row = [];
            $(this).find('td').each(function () {
                row.push($(this).text());
            });
            data.push(row);
        });

        $.ajax({
            url: "{% url 'save_uploaded_data' %}",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function (response) {
                if (response.success) {
                    alert('Dữ liệu đã được lưu thành công!');
                    location.reload();
                } else {
                    alert('Lỗi: ' + response.error_message);
                }
            },
            error: function () {
                alert('Lỗi khi lưu dữ liệu.');
            }
        });
    });
</script>
{% endblock %}

{% block css %}
<style>
    .custom-modal-xl {
        max-width: 90%;
    }

    #resultTableContainer {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}
